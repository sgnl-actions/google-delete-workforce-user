/**
 * @license MIT
 * Copyright (c) 2025 SGNL.ai, Inc.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";const e="SGNL-CAEP-Hub/2.0";async function r(r){const o=r.environment||{},t=r.secrets||{};if(t.BEARER_AUTH_TOKEN){const e=t.BEARER_AUTH_TOKEN;return e.startsWith("Bearer ")?e:`Bearer ${e}`}if(t.BASIC_PASSWORD&&t.BASIC_USERNAME){return`Basic ${btoa(`${t.BASIC_USERNAME}:${t.BASIC_PASSWORD}`)}`}if(t.OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN){const e=t.OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN;return e.startsWith("Bearer ")?e:`Bearer ${e}`}if(t.OAUTH2_CLIENT_CREDENTIALS_CLIENT_SECRET){const r=o.OAUTH2_CLIENT_CREDENTIALS_TOKEN_URL,n=o.OAUTH2_CLIENT_CREDENTIALS_CLIENT_ID,s=t.OAUTH2_CLIENT_CREDENTIALS_CLIENT_SECRET;if(!r||!n)throw new Error("OAuth2 Client Credentials flow requires TOKEN_URL and CLIENT_ID in env");const a=await async function(r){const{tokenUrl:o,clientId:t,clientSecret:n,scope:s,audience:a,authStyle:c}=r;if(!o||!t||!n)throw new Error("OAuth2 Client Credentials flow requires tokenUrl, clientId, and clientSecret");const i=new URLSearchParams;i.append("grant_type","client_credentials"),s&&i.append("scope",s),a&&i.append("audience",a);const l={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json","User-Agent":e};if("InParams"===c)i.append("client_id",t),i.append("client_secret",n);else{const e=btoa(`${t}:${n}`);l.Authorization=`Basic ${e}`}const d=await fetch(o,{method:"POST",headers:l,body:i.toString()});if(!d.ok){let e;try{const r=await d.json();e=JSON.stringify(r)}catch{e=await d.text()}throw new Error(`OAuth2 token request failed: ${d.status} ${d.statusText} - ${e}`)}const E=await d.json();if(!E.access_token)throw new Error("No access_token in OAuth2 response");return E.access_token}({tokenUrl:r,clientId:n,clientSecret:s,scope:o.OAUTH2_CLIENT_CREDENTIALS_SCOPE,audience:o.OAUTH2_CLIENT_CREDENTIALS_AUDIENCE,authStyle:o.OAUTH2_CLIENT_CREDENTIALS_AUTH_STYLE});return`Bearer ${a}`}throw new Error("No authentication configured. Provide one of: BEARER_AUTH_TOKEN, BASIC_USERNAME/BASIC_PASSWORD, OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN, or OAUTH2_CLIENT_CREDENTIALS_*")}var o={invoke:async(o,t)=>{const{workforcePoolId:n,subjectId:s}=o;if(console.log(`Starting Google Workforce user deletion for subject ${s} in pool ${n}`),!s||"string"!=typeof s)throw new Error("Invalid or missing subjectId parameter");if(!n||"string"!=typeof n)throw new Error("Invalid or missing workforcePoolId parameter");let a;try{a=function(e,r){const o=r.environment||{},t=e?.address||o.ADDRESS;if(!t)throw new Error("No URL specified. Provide address parameter or ADDRESS environment variable");return t.endsWith("/")?t.slice(0,-1):t}(o,t)}catch(E){a="https://iam.googleapis.com"}const c=await r(t),i=await async function(r,o,t,n){const s=`${t}/v1/locations/global/workforcePools/${r}/subjects/${o}`,a=await fetch(s,{method:"DELETE",headers:{Authorization:n,"User-Agent":e}});let c=null;try{const e=await a.text();e&&(c=JSON.parse(e))}catch{}return{success:a.ok,status:a.status,data:c}}(n,s,a,c);if(i.success)return console.log(`Successfully deleted workforce user ${s}`),{subjectId:s,workforcePoolId:n,deleted:!0,deletedAt:(new Date).toISOString()};const l=i.status;if(404===l)return console.log(`Workforce user ${s} not found - already deleted`),{subjectId:s,workforcePoolId:n,deleted:!0,alreadyDeleted:!0,deletedAt:(new Date).toISOString()};let d=`Failed to delete workforce user: ${l}`;i.error?.error?.message?d=`Failed to delete workforce user: ${i.error.error.message}`:"string"==typeof i.error&&(d=`Failed to delete workforce user: ${i.error}`),console.error("Google API error:",i.error);const E=new Error(d);throw E.statusCode=l,E},error:async(e,r)=>{const{error:o,subjectId:t,workforcePoolId:n}=e;throw console.error(`Workforce user deletion failed for ${t} in pool ${n}: ${o.message}`),o},halt:async(e,r)=>{const{reason:o,subjectId:t,workforcePoolId:n}=e;return console.log(`Workforce user deletion job is being halted (${o}) for ${t} in pool ${n}`),{subjectId:t||"unknown",workforcePoolId:n||"unknown",reason:o,haltedAt:(new Date).toISOString(),cleanupCompleted:!0}}};module.exports=o;
